<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 7.0.1 and Furo 2023.05.20 -->
        <title>cdp_scrapers.legistar_utils - cdp-scrapers 0.1.dev1+g5d6ba64 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=e6660623a769aa55fea372102b9bf3151b292993" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">cdp-scrapers 0.1.dev1+g5d6ba64 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">cdp-scrapers 0.1.dev1+g5d6ba64 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../finding_legistar_id.html">Searching for your Municipality's Legistar ID</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../legistar_scraper.html">LegistarScraper</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../modules.html">Package modules</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Package modules</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../cdp_scrapers.html">cdp_scrapers package</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of cdp_scrapers package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cdp_scrapers.instances.html">cdp_scrapers.instances package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core Components:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cdp_scrapers.instances.empty.get_events.html">cdp_scrapers.instances.empty.get_events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdp_scrapers.legistar_utils.LegistarScraper.html">cdp_scrapers.legistar_utils.LegistarScraper</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for cdp_scrapers.legistar_utils</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">JSONDecodeError</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">NamedTuple</span>
<span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">HTTPError</span><span class="p">,</span> <span class="n">URLError</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote_plus</span><span class="p">,</span> <span class="n">urlsplit</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">cdp_backend.database.constants</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">EventMinutesItemDecision</span><span class="p">,</span>
    <span class="n">MatterStatusDecision</span><span class="p">,</span>
    <span class="n">VoteDecision</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cdp_backend.pipeline.ingestion_models</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Body</span><span class="p">,</span>
    <span class="n">EventIngestionModel</span><span class="p">,</span>
    <span class="n">EventMinutesItem</span><span class="p">,</span>
    <span class="n">Matter</span><span class="p">,</span>
    <span class="n">MinutesItem</span><span class="p">,</span>
    <span class="n">Person</span><span class="p">,</span>
    <span class="n">Role</span><span class="p">,</span>
    <span class="n">Session</span><span class="p">,</span>
    <span class="n">SupportingFile</span><span class="p">,</span>
    <span class="n">Vote</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.legistar_content_parsers</span> <span class="kn">import</span> <span class="n">all_parsers</span>
<span class="kn">from</span> <span class="nn">.scraper_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IngestionModelScraper</span><span class="p">,</span>
    <span class="n">reduced_list</span><span class="p">,</span>
    <span class="n">sanitize_roles</span><span class="p">,</span>
    <span class="n">str_simplified</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.types</span> <span class="kn">import</span> <span class="n">ContentURIs</span><span class="p">,</span> <span class="n">LegistarContentParser</span><span class="p">,</span> <span class="n">ScraperStaticData</span>

<span class="c1">###############################################################################</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1">###############################################################################</span>

<span class="n">LEGISTAR_BASE</span> <span class="o">=</span> <span class="s2">&quot;http://webapi.legistar.com/v1/</span><span class="si">{client}</span><span class="s2">&quot;</span>
<span class="n">LEGISTAR_VOTE_BASE</span> <span class="o">=</span> <span class="n">LEGISTAR_BASE</span> <span class="o">+</span> <span class="s2">&quot;/EventItems&quot;</span>
<span class="n">LEGISTAR_EVENT_BASE</span> <span class="o">=</span> <span class="n">LEGISTAR_BASE</span> <span class="o">+</span> <span class="s2">&quot;/Events&quot;</span>
<span class="n">LEGISTAR_MATTER_BASE</span> <span class="o">=</span> <span class="n">LEGISTAR_BASE</span> <span class="o">+</span> <span class="s2">&quot;/Matters&quot;</span>
<span class="n">LEGISTAR_PERSON_BASE</span> <span class="o">=</span> <span class="n">LEGISTAR_BASE</span> <span class="o">+</span> <span class="s2">&quot;/Persons&quot;</span>
<span class="n">LEGISTAR_BODY_BASE</span> <span class="o">=</span> <span class="n">LEGISTAR_BASE</span> <span class="o">+</span> <span class="s2">&quot;/Bodies&quot;</span>

<span class="c1"># e.g. Session.video_uri =  EventVideoPath from legistar api</span>
<span class="n">LEGISTAR_SESSION_VIDEO_URI</span> <span class="o">=</span> <span class="s2">&quot;EventVideoPath&quot;</span>
<span class="n">LEGISTAR_EV_MINUTE_DECISION</span> <span class="o">=</span> <span class="s2">&quot;EventItemPassedFlagName&quot;</span>
<span class="c1"># NOTE: EventItemAgendaSequence is also a candidate for this</span>
<span class="n">LEGISTAR_EV_INDEX</span> <span class="o">=</span> <span class="s2">&quot;EventItemMinutesSequence&quot;</span>
<span class="n">LEGISTAR_PERSON_EMAIL</span> <span class="o">=</span> <span class="s2">&quot;PersonEmail&quot;</span>
<span class="n">LEGISTAR_PERSON_EXT_ID</span> <span class="o">=</span> <span class="s2">&quot;PersonId&quot;</span>
<span class="n">LEGISTAR_PERSON_NAME</span> <span class="o">=</span> <span class="s2">&quot;PersonFullName&quot;</span>
<span class="n">LEGISTAR_PERSON_PHONE</span> <span class="o">=</span> <span class="s2">&quot;PersonPhone&quot;</span>
<span class="n">LEGISTAR_PERSON_WEBSITE</span> <span class="o">=</span> <span class="s2">&quot;PersonWWW&quot;</span>
<span class="n">LEGISTAR_PERSON_ACTIVE</span> <span class="o">=</span> <span class="s2">&quot;PersonActiveFlag&quot;</span>
<span class="n">LEGISTAR_PERSON_ROLES</span> <span class="o">=</span> <span class="s2">&quot;OfficeRecordInfo&quot;</span>
<span class="n">LEGISTAR_BODY_NAME</span> <span class="o">=</span> <span class="s2">&quot;BodyName&quot;</span>
<span class="n">LEGISTAR_BODY_EXT_ID</span> <span class="o">=</span> <span class="s2">&quot;BodyId&quot;</span>
<span class="n">LEGISTAR_BODY_ACTIVE</span> <span class="o">=</span> <span class="s2">&quot;BodyActiveFlag&quot;</span>
<span class="n">LEGISTAR_VOTE_DECISION</span> <span class="o">=</span> <span class="s2">&quot;VoteResult&quot;</span>
<span class="n">LEGISTAR_VOTE_EXT_ID</span> <span class="o">=</span> <span class="s2">&quot;VoteId&quot;</span>
<span class="n">LEGISTAR_FILE_EXT_ID</span> <span class="o">=</span> <span class="s2">&quot;MatterAttachmentId&quot;</span>
<span class="n">LEGISTAR_FILE_NAME</span> <span class="o">=</span> <span class="s2">&quot;MatterAttachmentName&quot;</span>
<span class="n">LEGISTAR_FILE_URI</span> <span class="o">=</span> <span class="s2">&quot;MatterAttachmentHyperlink&quot;</span>
<span class="n">LEGISTAR_MATTER_EXT_ID</span> <span class="o">=</span> <span class="s2">&quot;EventItemMatterId&quot;</span>
<span class="n">LEGISTAR_MATTER_TITLE</span> <span class="o">=</span> <span class="s2">&quot;EventItemMatterFile&quot;</span>
<span class="n">LEGISTAR_MATTER_NAME</span> <span class="o">=</span> <span class="s2">&quot;EventItemMatterName&quot;</span>
<span class="n">LEGISTAR_MATTER_TYPE</span> <span class="o">=</span> <span class="s2">&quot;EventItemMatterType&quot;</span>
<span class="n">LEGISTAR_MATTER_STATUS</span> <span class="o">=</span> <span class="s2">&quot;EventItemMatterStatus&quot;</span>
<span class="n">LEGISTAR_MATTER_SPONSORS</span> <span class="o">=</span> <span class="s2">&quot;MatterSponsorInfo&quot;</span>
<span class="n">LEGISTAR_SPONSOR_PERSON</span> <span class="o">=</span> <span class="s2">&quot;SponsorPersonInfo&quot;</span>
<span class="c1"># Session.session_datetime is a combo of EventDate and EventTime</span>
<span class="c1"># TODO: this means same time for all Sessions in a EventIngestionModel.</span>
<span class="c1">#       some other legistar api data that can be used instead</span>
<span class="n">LEGISTAR_SESSION_DATE</span> <span class="o">=</span> <span class="s2">&quot;EventDate&quot;</span>
<span class="n">LEGISTAR_SESSION_TIME</span> <span class="o">=</span> <span class="s2">&quot;EventTime&quot;</span>
<span class="n">LEGISTAR_AGENDA_URI</span> <span class="o">=</span> <span class="s2">&quot;EventAgendaFile&quot;</span>
<span class="n">LEGISTAR_MINUTES_URI</span> <span class="o">=</span> <span class="s2">&quot;EventMinutesFile&quot;</span>
<span class="n">LEGISTAR_MINUTE_EXT_ID</span> <span class="o">=</span> <span class="s2">&quot;EventItemId&quot;</span>
<span class="n">LEGISTAR_MINUTE_NAME</span> <span class="o">=</span> <span class="s2">&quot;EventItemTitle&quot;</span>
<span class="n">LEGISTAR_VOTE_VAL_ID</span> <span class="o">=</span> <span class="s2">&quot;VoteValueId&quot;</span>
<span class="n">LEGISTAR_VOTE_VAL_NAME</span> <span class="o">=</span> <span class="s2">&quot;VoteValueName&quot;</span>
<span class="n">LEGISTAR_ROLE_BODY</span> <span class="o">=</span> <span class="s2">&quot;OfficeRecordBodyInfo&quot;</span>
<span class="n">LEGISTAR_ROLE_BODY_ALT</span> <span class="o">=</span> <span class="s2">&quot;OfficeRecordBodyName&quot;</span>
<span class="n">LEGISTAR_ROLE_START</span> <span class="o">=</span> <span class="s2">&quot;OfficeRecordStartDate&quot;</span>
<span class="n">LEGISTAR_ROLE_END</span> <span class="o">=</span> <span class="s2">&quot;OfficeRecordEndDate&quot;</span>
<span class="n">LEGISTAR_ROLE_EXT_ID</span> <span class="o">=</span> <span class="s2">&quot;OfficeRecordId&quot;</span>
<span class="n">LEGISTAR_ROLE_TITLE</span> <span class="o">=</span> <span class="s2">&quot;OfficeRecordTitle&quot;</span>
<span class="n">LEGISTAR_ROLE_TITLE_ALT</span> <span class="o">=</span> <span class="s2">&quot;OfficeRecordMemberType&quot;</span>

<span class="n">LEGISTAR_EV_ITEMS</span> <span class="o">=</span> <span class="s2">&quot;EventItems&quot;</span>
<span class="n">LEGISTAR_EV_ATTACHMENTS</span> <span class="o">=</span> <span class="s2">&quot;EventItemMatterAttachments&quot;</span>
<span class="n">LEGISTAR_EV_VOTES</span> <span class="o">=</span> <span class="s2">&quot;EventItemVoteInfo&quot;</span>
<span class="n">LEGISTAR_VOTE_PERSONS</span> <span class="o">=</span> <span class="s2">&quot;PersonInfo&quot;</span>
<span class="n">LEGISTAR_EV_SITE_URL</span> <span class="o">=</span> <span class="s2">&quot;EventInSiteURL&quot;</span>
<span class="n">LEGISTAR_EV_EXT_ID</span> <span class="o">=</span> <span class="s2">&quot;EventId&quot;</span>
<span class="n">LEGISTAR_EV_BODY</span> <span class="o">=</span> <span class="s2">&quot;EventBodyInfo&quot;</span>

<span class="n">LEGISTAR_DATETIME_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span>
<span class="c1">###############################################################################</span>


<span class="n">known_legistar_persons</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">known_legistar_bodies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># video web page parser type per municipality</span>
<span class="n">video_page_parser</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LegistarContentParser</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="get_legistar_body"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.get_legistar_body">[docs]</a><span class="k">def</span> <span class="nf">get_legistar_body</span><span class="p">(</span>
    <span class="n">client</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">body_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return information for a single legistar body in JSON.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    client: str</span>
<span class="sd">        Which legistar client to target. Ex: &quot;seattle&quot;</span>
<span class="sd">    body_id: int</span>
<span class="sd">        Unique ID for this body in the legistar municipality</span>
<span class="sd">    use_cache: bool</span>
<span class="sd">        True: Store result to prevent querying repeatedly for same body_id</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    body: Dict[str, Any]</span>
<span class="sd">        legistar API body</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    known_legistar_bodies cache is cleared for every LegistarScraper.get_events() call</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">known_legistar_bodies</span>

    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">known_legistar_bodies</span><span class="p">[</span><span class="n">body_id</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># new body</span>
            <span class="k">pass</span>

    <span class="n">body_request_format</span> <span class="o">=</span> <span class="n">LEGISTAR_BODY_BASE</span> <span class="o">+</span> <span class="s2">&quot;/</span><span class="si">{body_id}</span><span class="s2">&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">body_request_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
            <span class="n">body_id</span><span class="o">=</span><span class="n">body_id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="n">known_legistar_bodies</span><span class="p">[</span><span class="n">body_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">body</span>
    <span class="k">return</span> <span class="n">body</span></div>


<div class="viewcode-block" id="get_legistar_person"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.get_legistar_person">[docs]</a><span class="k">def</span> <span class="nf">get_legistar_person</span><span class="p">(</span>
    <span class="n">client</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">person_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return information for a single legistar person in JSON.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    client: str</span>
<span class="sd">        Which legistar client to target. Ex: &quot;seattle&quot;</span>
<span class="sd">    person_id: int</span>
<span class="sd">        Unique ID for this person in the legistar municipality</span>
<span class="sd">    use_cache: bool</span>
<span class="sd">        True: Store result to prevent querying repeatedly for same person_id</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    person: Dict[str, Any]</span>
<span class="sd">        legistar API person</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    known_legistar_persons cache is cleared for every LegistarScraper.get_events() call</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">known_legistar_persons</span>

    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">known_legistar_persons</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># new person</span>
            <span class="k">pass</span>

    <span class="n">person_request_format</span> <span class="o">=</span> <span class="n">LEGISTAR_PERSON_BASE</span> <span class="o">+</span> <span class="s2">&quot;/</span><span class="si">{person_id}</span><span class="s2">&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">person_request_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
            <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
            <span class="n">known_legistar_persons</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">person</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="c1"># all known OfficeRecords (roles) for this person</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="p">(</span><span class="n">person_request_format</span> <span class="o">+</span> <span class="s2">&quot;/OfficeRecords&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
            <span class="n">person_id</span><span class="o">=</span><span class="n">person_id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">person</span><span class="p">[</span><span class="n">LEGISTAR_PERSON_ROLES</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
            <span class="n">known_legistar_persons</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">person</span>
        <span class="k">return</span> <span class="n">person</span>

    <span class="n">office_records</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">office_records</span><span class="p">:</span>
        <span class="c1"># body for this role</span>
        <span class="n">record</span><span class="p">[</span><span class="n">LEGISTAR_ROLE_BODY</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_legistar_body</span><span class="p">(</span>
            <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">body_id</span><span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;OfficeRecordBodyId&quot;</span><span class="p">],</span> <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span>
        <span class="p">)</span>

    <span class="n">person</span><span class="p">[</span><span class="n">LEGISTAR_PERSON_ROLES</span><span class="p">]</span> <span class="o">=</span> <span class="n">office_records</span>
    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="n">known_legistar_persons</span><span class="p">[</span><span class="n">person_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">person</span>
    <span class="k">return</span> <span class="n">person</span></div>


<div class="viewcode-block" id="get_legistar_events_for_timespan"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.get_legistar_events_for_timespan">[docs]</a><span class="k">def</span> <span class="nf">get_legistar_events_for_timespan</span><span class="p">(</span>
    <span class="n">client</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">begin</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all legistar events and each events minutes items, people, and votes, for a</span>
<span class="sd">    client for a given timespan.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    client: str</span>
<span class="sd">        Which legistar client to target. Ex: &quot;seattle&quot;</span>
<span class="sd">    begin: Optional[datetime]</span>
<span class="sd">        The timespan beginning datetime to query for events after.</span>
<span class="sd">        Default: UTC now - 1 day</span>
<span class="sd">    end: Optional[datetime]</span>
<span class="sd">        The timespan end datetime to query for events before.</span>
<span class="sd">        Default: UTC now</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    events: List[Dict]</span>
<span class="sd">        All legistar events that occur between the datetimes provided for the client</span>
<span class="sd">        provided. Additionally, requests and attaches agenda items, minutes items, any</span>
<span class="sd">        attachments, called &quot;EventItems&quot;, requests votes for any of these &quot;EventItems&quot;,</span>
<span class="sd">        and requests person information for any vote.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set defaults</span>
    <span class="k">if</span> <span class="n">begin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

    <span class="c1"># The unformatted request parts</span>
    <span class="n">filter_datetime_format</span> <span class="o">=</span> <span class="s2">&quot;EventDate+</span><span class="si">{op}</span><span class="s2">+datetime%27</span><span class="si">{dt}</span><span class="s2">%27&quot;</span>
    <span class="n">request_format</span> <span class="o">=</span> <span class="n">LEGISTAR_EVENT_BASE</span> <span class="o">+</span> <span class="s2">&quot;?$filter=</span><span class="si">{begin}</span><span class="s2">+and+</span><span class="si">{end}</span><span class="s2">&quot;</span>

    <span class="c1"># a given person and/or body&#39;s information being updated</span>
    <span class="c1"># during the lifetime of this single call is miniscule.</span>
    <span class="c1"># use a cache to prevent 10s-100s of web requests</span>
    <span class="c1"># for the same person/body</span>
    <span class="k">global</span> <span class="n">known_legistar_persons</span><span class="p">,</span> <span class="n">known_legistar_bodies</span>
    <span class="c1"># See Also</span>
    <span class="c1"># get_legistar_person()</span>
    <span class="n">known_legistar_persons</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="c1"># See Also</span>
    <span class="c1"># get_legistar_body()</span>
    <span class="n">known_legistar_bodies</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># Get response from formatted request</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Querying Legistar for events between: </span><span class="si">{</span><span class="n">begin</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">request_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
            <span class="n">begin</span><span class="o">=</span><span class="n">filter_datetime_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">op</span><span class="o">=</span><span class="s2">&quot;ge&quot;</span><span class="p">,</span>
                <span class="n">dt</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">end</span><span class="o">=</span><span class="n">filter_datetime_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">op</span><span class="o">=</span><span class="s2">&quot;lt&quot;</span><span class="p">,</span>
                <span class="n">dt</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="c1"># Get all event items for each event</span>
    <span class="n">item_request_format</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">LEGISTAR_EVENT_BASE</span>
        <span class="o">+</span> <span class="s2">&quot;/</span><span class="si">{event_id}</span><span class="s2">/EventItems?AgendaNote=1&amp;MinutesNote=1&amp;Attachments=1&quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="c1"># Attach the Event Items to the event</span>
        <span class="n">event</span><span class="p">[</span><span class="s2">&quot;EventItems&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">item_request_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">event_id</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;EventId&quot;</span><span class="p">])</span>
        <span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="c1"># Attach info for the body responsible for this event</span>
        <span class="n">event</span><span class="p">[</span><span class="n">LEGISTAR_EV_BODY</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_legistar_body</span><span class="p">(</span>
            <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">body_id</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;EventBodyId&quot;</span><span class="p">],</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Get vote information</span>
        <span class="k">for</span> <span class="n">event_item</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;EventItems&quot;</span><span class="p">]:</span>
            <span class="n">vote_request_format</span> <span class="o">=</span> <span class="n">LEGISTAR_VOTE_BASE</span> <span class="o">+</span> <span class="s2">&quot;/</span><span class="si">{event_item_id}</span><span class="s2">/Votes&quot;</span>
            <span class="n">event_item</span><span class="p">[</span><span class="s2">&quot;EventItemVoteInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">vote_request_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                    <span class="n">event_item_id</span><span class="o">=</span><span class="n">event_item</span><span class="p">[</span><span class="s2">&quot;EventItemId&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

            <span class="c1"># Get person information</span>
            <span class="k">for</span> <span class="n">vote_info</span> <span class="ow">in</span> <span class="n">event_item</span><span class="p">[</span><span class="s2">&quot;EventItemVoteInfo&quot;</span><span class="p">]:</span>
                <span class="n">vote_info</span><span class="p">[</span><span class="s2">&quot;PersonInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_legistar_person</span><span class="p">(</span>
                    <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                    <span class="n">person_id</span><span class="o">=</span><span class="n">vote_info</span><span class="p">[</span><span class="s2">&quot;VotePersonId&quot;</span><span class="p">],</span>
                    <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event_item</span><span class="p">[</span><span class="s2">&quot;EventItemMatterId&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">event_item</span><span class="p">[</span><span class="s2">&quot;EventItemMatterId&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">event_item</span><span class="p">[</span><span class="n">LEGISTAR_MATTER_SPONSORS</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># this matter&#39;s sponsors</span>
                <span class="n">sponsor_request_format</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">LEGISTAR_MATTER_BASE</span> <span class="o">+</span> <span class="s2">&quot;/</span><span class="si">{event_item_matter_id}</span><span class="s2">/Sponsors&quot;</span>
                <span class="p">)</span>
                <span class="n">sponsors</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">sponsor_request_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                        <span class="n">event_item_matter_id</span><span class="o">=</span><span class="n">event_item</span><span class="p">[</span><span class="s2">&quot;EventItemMatterId&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

                <span class="c1"># legistar MatterSponsor just has a reference to a Person</span>
                <span class="c1"># so further obtain the actual Person information</span>
                <span class="k">for</span> <span class="n">sponsor</span> <span class="ow">in</span> <span class="n">sponsors</span><span class="p">:</span>
                    <span class="n">sponsor</span><span class="p">[</span><span class="n">LEGISTAR_SPONSOR_PERSON</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_legistar_person</span><span class="p">(</span>
                        <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">sponsor</span><span class="p">[</span><span class="s2">&quot;MatterSponsorNameId&quot;</span><span class="p">],</span>
                        <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">event_item</span><span class="p">[</span><span class="n">LEGISTAR_MATTER_SPONSORS</span><span class="p">]</span> <span class="o">=</span> <span class="n">sponsors</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="si">}</span><span class="s2"> Legistar events&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="ContentUriScrapeResult"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.ContentUriScrapeResult">[docs]</a><span class="k">class</span> <span class="nc">ContentUriScrapeResult</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<div class="viewcode-block" id="ContentUriScrapeResult.Status"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.ContentUriScrapeResult.Status">[docs]</a>    <span class="k">class</span> <span class="nc">Status</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Status of content parsing.&quot;&quot;&quot;</span>

        <span class="c1"># Web page(s) are in unrecognized structure</span>
        <span class="n">UnrecognizedPatternError</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Error in accessing some resource</span>
        <span class="n">ResourceAccessError</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="c1"># Video was not provided for the event</span>
        <span class="n">ContentNotProvidedError</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>
        <span class="c1"># Found URIs to video and optional caption</span>
        <span class="n">Ok</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="n">status</span><span class="p">:</span> <span class="n">Status</span>
    <span class="n">uris</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ContentURIs</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="parse_video_page_url"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.parse_video_page_url">[docs]</a><span class="k">def</span> <span class="nf">parse_video_page_url</span><span class="p">(</span><span class="n">video_page_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">ContentURIs</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return URLs for videos and captions from a Legistar/Granicus-hosted video web page.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    video_page_url: str</span>
<span class="sd">        The URL for the page of the legistar video</span>
<span class="sd">    client: str</span>
<span class="sd">        Which legistar client to target. Ex: &quot;seattle&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    uris: Optional[List[ContentURIs]]</span>
<span class="sd">        URIs for video and optional caption</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">video_page_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
        <span class="c1"># now load the page to get the actual video url</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">video_page_parser</span><span class="p">:</span>
            <span class="c1"># we already know which format parser to call</span>
            <span class="n">uris</span> <span class="o">=</span> <span class="n">video_page_parser</span><span class="p">[</span><span class="n">client</span><span class="p">](</span><span class="n">client</span><span class="p">,</span> <span class="n">soup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parser</span> <span class="ow">in</span> <span class="n">all_parsers</span><span class="p">:</span>
                <span class="n">uris</span> <span class="o">=</span> <span class="n">parser</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">soup</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">uris</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># remember so we just call this from here on</span>
                    <span class="n">video_page_parser</span><span class="p">[</span><span class="n">client</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parser</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">client</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">uris</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">uris</span></div>


<div class="viewcode-block" id="get_legistar_content_uris"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.get_legistar_content_uris">[docs]</a><span class="k">def</span> <span class="nf">get_legistar_content_uris</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">legistar_ev</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContentUriScrapeResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return URLs for videos and captions from a Legistar/Granicus-hosted video web page.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    client: str</span>
<span class="sd">        Which legistar client to target. Ex: &quot;seattle&quot;</span>
<span class="sd">    legistar_ev: Dict</span>
<span class="sd">        Data for one Legistar Event.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ContentUriScrapeResult</span>
<span class="sd">        status: ContentUriScrapeResult.Status</span>
<span class="sd">            Status code describing the scraping process. Use uris only if status is Ok</span>
<span class="sd">        uris: Optional[List[ContentURIs]]</span>
<span class="sd">            URIs for video and optional caption</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NotImplementedError</span>
<span class="sd">        Means the content structure of the web page hosting session video has changed.</span>
<span class="sd">        We need explicit review and update the scraping code.</span>
<span class="sd">    ConnectionError</span>
<span class="sd">        When the Legistar site (e.g. *.legistar.com) itself may be down.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    LegistarScraper.get_content_uris</span>
<span class="sd">    cdp_scrapers.legistar_content_parsers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">video_page_parser</span>

    <span class="c1"># prefer video file path in legistar Event.EventVideoPath</span>
    <span class="k">if</span> <span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_SESSION_VIDEO_URI</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">ContentUriScrapeResult</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Ok</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">ContentURIs</span><span class="p">(</span>
                    <span class="n">video_uri</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_SESSION_VIDEO_URI</span><span class="p">]),</span>
                    <span class="n">caption_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_EV_SITE_URL</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ContentUriScrapeResult</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">UnrecognizedPatternError</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># a td tag with a certain id pattern.</span>
        <span class="c1"># this is usually something like</span>
        <span class="c1"># https://somewhere.legistar.com/MeetingDetail.aspx...</span>
        <span class="c1"># that is a summary-like page for a meeting</span>
        <span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_EV_SITE_URL</span><span class="p">])</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
            <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;server error&quot;</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">url_attrs</span> <span class="o">=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_EV_SITE_URL</span><span class="p">])</span>
                    <span class="n">netloc</span> <span class="o">=</span> <span class="n">url_attrs</span><span class="o">.</span><span class="n">netloc</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">netloc</span> <span class="o">=</span> <span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_EV_SITE_URL</span><span class="p">]</span>
                <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">netloc</span><span class="si">}</span><span class="s2"> appears to be down: </span><span class="si">{</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">soup</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">URLError</span><span class="p">,</span> <span class="n">HTTPError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_EV_SITE_URL</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ContentUriScrapeResult</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ResourceAccessError</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># this gets us the url for the web PAGE containing the video</span>
    <span class="c1"># video link is provided in the window.open()command inside onclick event</span>
    <span class="c1"># &lt;a id=&quot;ctl00_ContentPlaceHolder1_hypVideo&quot;</span>
    <span class="c1"># data-event-id=&quot;75f1e143-6756-496f-911b-d3abe61d64a5&quot;</span>
    <span class="c1"># data-running-text=&quot;In&amp;amp;nbsp;progress&quot; class=&quot;videolink&quot;</span>
    <span class="c1"># onclick=&quot;window.open(&#39;Video.aspx?</span>
    <span class="c1"># Mode=Granicus&amp;amp;ID1=8844&amp;amp;G=D64&amp;amp;Mode2=Video&#39;,&#39;video&#39;);</span>
    <span class="c1"># return false;&quot;</span>
    <span class="c1"># href=&quot;#&quot; style=&quot;color:Blue;font-family:Tahoma;font-size:10pt;&quot;&gt;Video&lt;/a&gt;</span>
    <span class="n">extract_url</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
        <span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;ct\S*_ContentPlaceHolder\S*_hypVideo&quot;</span><span class="p">),</span>
        <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;videolink&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">extract_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ContentUriScrapeResult</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">UnrecognizedPatternError</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># the &lt;a&gt; tag will not have this attribute if there is no video</span>
    <span class="k">if</span> <span class="s2">&quot;onclick&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extract_url</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ContentUriScrapeResult</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ContentNotProvidedError</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># NOTE: after this point, failing to scrape video url should raise an exception.</span>
    <span class="c1"># we need to be alerted that we probabaly have a new web page structure.</span>

    <span class="n">extract_url</span> <span class="o">=</span> <span class="n">extract_url</span><span class="p">[</span><span class="s2">&quot;onclick&quot;</span><span class="p">]</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">extract_url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">extract_url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&#39;,&quot;</span><span class="p">)</span>
    <span class="n">video_page_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">client</span><span class="si">}</span><span class="s2">.legistar.com/</span><span class="si">{</span><span class="n">extract_url</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_EV_SITE_URL</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">video_page_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">uris</span> <span class="o">=</span> <span class="n">parse_video_page_url</span><span class="p">(</span><span class="n">video_page_url</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error opening </span><span class="si">{</span><span class="n">video_page_url</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ContentUriScrapeResult</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ResourceAccessError</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">uris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;get_legistar_content_uris() needs attention. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Unrecognized video web page HTML structure: </span><span class="si">{</span><span class="n">video_page_url</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ContentUriScrapeResult</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Ok</span><span class="p">,</span> <span class="n">uris</span><span class="p">)</span></div>


<div class="viewcode-block" id="LegistarScraper"><a class="viewcode-back" href="../../cdp_scrapers.legistar_utils.LegistarScraper.html#cdp_scrapers.legistar_utils.LegistarScraper">[docs]</a><span class="k">class</span> <span class="nc">LegistarScraper</span><span class="p">(</span><span class="n">IngestionModelScraper</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for transforming Legistar API data to CDP IngestionModel.</span>

<span class="sd">    If get_events() naively fails and raises an error, a given installation must define</span>
<span class="sd">    a derived class and implement the get_content_uris() function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    client: str</span>
<span class="sd">        Legistar client name, e.g. &quot;seattle&quot; for Seattle, &quot;kingcounty&quot; for King County.</span>
<span class="sd">    timezone: str</span>
<span class="sd">        The timezone for the target client.</span>
<span class="sd">        i.e. &quot;America/Los_Angeles&quot; or &quot;America/New_York&quot;</span>
<span class="sd">        See https://en.wikipedia.org/wiki/List_of_tz_database_time_zones for canonical</span>
<span class="sd">        timezones.</span>
<span class="sd">    ignore_minutes_item_patterns: List[str]</span>
<span class="sd">        A list of string patterns or substrings to act as a minutes item filter.</span>
<span class="sd">        Any item in the provided list will be compiled as a regex string and any</span>
<span class="sd">        minute&#39;s item that contains the compiled pattern will be filtered out of the</span>
<span class="sd">        produced CDP minutes item list.</span>
<span class="sd">        Default: [] (do not filter any minutes items)</span>
<span class="sd">    vote_approve_pattern: str</span>
<span class="sd">        Regex pattern used to convert Legistar instance&#39;s votes in approval value to CDP</span>
<span class="sd">        constant value.</span>
<span class="sd">        Default: &quot;approve|favor|yes&quot;</span>
<span class="sd">    vote_abstain_pattern: str</span>
<span class="sd">        Regex pattern used to convert Legistar instance&#39;s abstension value to CDP</span>
<span class="sd">        constant value. Note, this is a pure abstension, not an &quot;approval by</span>
<span class="sd">        abstention&quot; or &quot;rejection by abstension&quot; value. Those should be places in</span>
<span class="sd">        vote_approve_pattern and vote_reject_pattern respectively.</span>
<span class="sd">        Default: &quot;abstain|refuse|refrain&quot;</span>
<span class="sd">    vote_reject_pattern: str</span>
<span class="sd">        Regex pattern used to convert Legistar instance&#39;s votes in rejection value to</span>
<span class="sd">        CDP constant value.</span>
<span class="sd">        Default: &quot;reject|oppose|no&quot;</span>
<span class="sd">    vote_absent_pattern: str</span>
<span class="sd">        Regex pattern used to convert Legistar instance&#39;s excused absense value to CDP</span>
<span class="sd">        constant value.</span>
<span class="sd">        Default: &quot;absent&quot;</span>
<span class="sd">    vote_nonvoting_pattern: str</span>
<span class="sd">        Regex pattern used to convert Legistar instance&#39;s non-voting value to CDP</span>
<span class="sd">        constant value.</span>
<span class="sd">        Default: &quot;nv|(?:non.*voting)&quot;</span>
<span class="sd">    matter_adopted_pattern: str</span>
<span class="sd">        Regex pattern used to convert Legistar instance&#39;s matter was adopted to CDP</span>
<span class="sd">        constant value.</span>
<span class="sd">        Default: &quot;approved|confirmed|passed|adopted&quot;</span>
<span class="sd">    matter_in_progess_pattern: str</span>
<span class="sd">        Regex pattern used to convert Legistar instance&#39;s matter is in-progress to</span>
<span class="sd">        CDP constant value.</span>
<span class="sd">        Default: &quot;heard|ready|filed|held|(?:in\s*committee)&quot;</span>
<span class="sd">    matter_rejected_pattern: str</span>
<span class="sd">        Regex pattern used to convert Legistar instance&#39;s matter was rejected to CDP</span>
<span class="sd">        constant value.</span>
<span class="sd">        Default: &quot;rejected|dropped&quot;</span>
<span class="sd">    minutes_item_decision_passed_pattern: str</span>
<span class="sd">        Regex pattern used to convert Legistar instance&#39;s minutes item passage to CDP</span>
<span class="sd">        constant value.</span>
<span class="sd">        Default: &quot;pass&quot;</span>
<span class="sd">    minutes_item_decision_failed_pattern: str</span>
<span class="sd">        Regex pattern used to convert Legistar instance&#39;s minutes item failure to CDP</span>
<span class="sd">        constant value.</span>
<span class="sd">        Default: &quot;not|fail&quot;</span>
<span class="sd">    static_data: Optional[ScraperStaticData]</span>
<span class="sd">        predefined Seats, Bodies and Persons used to provide more accurate Person.seat.</span>
<span class="sd">    person_aliases: Optional[Dict[str, Set[str]]]</span>
<span class="sd">        Dictionary used to catch name aliases</span>
<span class="sd">        and resolve improperly unique Persons to the one correct Person.</span>
<span class="sd">        Default: None</span>
<span class="sd">    role_replacements: Optional[Dict[str, str]]</span>
<span class="sd">        Dictionary used to replace role titles with CDP standard role titles.</span>
<span class="sd">        The keys should be titles you want to replace and the values should be a</span>
<span class="sd">        CDP standard role.</span>
<span class="sd">        Default: None</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    cdp_scrapers.legistar_utils.LegistarScraper.get_content_uris</span>
<span class="sd">    cdp_scrapers.instances.seattle.SeattleScraper</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LegistarScraper.__init__"><a class="viewcode-back" href="../../cdp_scrapers.legistar_utils.LegistarScraper.html#cdp_scrapers.legistar_utils.LegistarScraper.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">timezone</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ignore_minutes_item_patterns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">vote_approve_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;approve|favor|yes&quot;</span><span class="p">,</span>
        <span class="n">vote_abstain_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;abstain|refuse|refrain&quot;</span><span class="p">,</span>
        <span class="n">vote_reject_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;reject|oppose|no&quot;</span><span class="p">,</span>
        <span class="n">vote_absent_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;absent&quot;</span><span class="p">,</span>
        <span class="n">vote_nonvoting_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;nv|(?:non.*voting)&quot;</span><span class="p">,</span>
        <span class="n">matter_adopted_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;approved|confirmed|passed|adopted|consent|(?:voted.*com+it+ee)&quot;</span>
        <span class="p">),</span>
        <span class="n">matter_in_progress_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;heard|read|filed|held|(?:in.*com+it+ee)&quot;</span><span class="p">,</span>
        <span class="n">matter_rejected_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;rejected|dropped&quot;</span><span class="p">,</span>
        <span class="n">minutes_item_decision_passed_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;pass&quot;</span><span class="p">,</span>
        <span class="n">minutes_item_decision_failed_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;not|fail&quot;</span><span class="p">,</span>
        <span class="n">static_data</span><span class="p">:</span> <span class="n">ScraperStaticData</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">person_aliases</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">role_replacements</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="n">timezone</span><span class="p">,</span> <span class="n">person_aliases</span><span class="o">=</span><span class="n">person_aliases</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ignore_minutes_item_patterns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ignore_minutes_item_patterns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_minutes_item_patterns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">ignore_minutes_item_patterns</span>

        <span class="c1"># regex patterns used to infer cdp_backend.database.constants</span>
        <span class="c1"># from Legistar string fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vote_approve_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">vote_approve_pattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vote_abstain_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">vote_abstain_pattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vote_reject_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">vote_reject_pattern</span>
        <span class="c1"># TODO: need to debug these using real examples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vote_absent_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">vote_absent_pattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vote_nonvoting_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">vote_nonvoting_pattern</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">matter_adopted_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">matter_adopted_pattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matter_in_progress_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">matter_in_progress_pattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matter_rejected_patten</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">matter_rejected_pattern</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minutes_item_decision_passed_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">minutes_item_decision_passed_pattern</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minutes_item_decision_failed_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">minutes_item_decision_failed_pattern</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">static_data</span> <span class="o">=</span> <span class="n">static_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role_replacements</span> <span class="o">=</span> <span class="n">role_replacements</span> <span class="ow">or</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="LegistarScraper.get_matter_status"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_matter_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_matter_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legistar_matter_status</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return appropriate MatterStatusDecision constant from EventItemMatterStatus.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        legistar_matter_status: str</span>
<span class="sd">            Legistar API EventItemMatterStatus.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        matter_status: Optional[str]</span>
<span class="sd">            A constant from CDP allowed matter status decisions.</span>
<span class="sd">            None if missing information or if matter status decision parameter patterns</span>
<span class="sd">            are not inclusive to the Legistar matter status value.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        cdp_backend.database.constants.MatterStatusDecision</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">legistar_matter_status</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matter_adopted_pattern</span><span class="p">,</span> <span class="n">legistar_matter_status</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">MatterStatusDecision</span><span class="o">.</span><span class="n">ADOPTED</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matter_in_progress_pattern</span><span class="p">,</span>
                <span class="n">legistar_matter_status</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">MatterStatusDecision</span><span class="o">.</span><span class="n">IN_PROGRESS</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matter_rejected_patten</span><span class="p">,</span> <span class="n">legistar_matter_status</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">MatterStatusDecision</span><span class="o">.</span><span class="n">REJECTED</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;not able to decide MatterStatusDecision from &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">legistar_matter_status</span><span class="si">}</span><span class="s2">. consider updating matter_*_pattern&quot;</span>
        <span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no MatterStatusDecision filter for </span><span class="si">{</span><span class="n">legistar_matter_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LegistarScraper.get_minutes_item_decision"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_minutes_item_decision">[docs]</a>    <span class="k">def</span> <span class="nf">get_minutes_item_decision</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">legistar_item_passed_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return appropriate EventMinutesItemDecision constant from</span>
<span class="sd">        EventItemPassedFlagName.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        legistar_item_passed_name: str</span>
<span class="sd">            Legistar API EventItemPassedFlagName</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        emi_decision: Optional[str]</span>
<span class="sd">            A constant from CDP allowed minutes item decisions.</span>
<span class="sd">            None if missing information or if minutes item decision parameter</span>
<span class="sd">            patterns are no inclusive of the Legistar minutes item decision value.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        cdp_backend.database.constants.EventMinutesItemDecision</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">legistar_item_passed_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">minutes_item_decision_passed_pattern</span><span class="p">,</span>
                <span class="n">legistar_item_passed_name</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">EventMinutesItemDecision</span><span class="o">.</span><span class="n">PASSED</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">minutes_item_decision_failed_pattern</span><span class="p">,</span>
                <span class="n">legistar_item_passed_name</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">EventMinutesItemDecision</span><span class="o">.</span><span class="n">FAILED</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no EventMinutesItemDecision filter for </span><span class="si">{</span><span class="n">legistar_item_passed_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LegistarScraper.get_vote_decision"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_vote_decision">[docs]</a>    <span class="k">def</span> <span class="nf">get_vote_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legistar_vote</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return appropriate VoteDecision constant based on Legistar Vote.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        legistar_vote: Dict</span>
<span class="sd">            Legistar API Vote</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vote_decision: Optional[str]</span>
<span class="sd">            A constant from CDP allowed vote decisions.</span>
<span class="sd">            None if missing vote information or if vote decision parameter patterns are</span>
<span class="sd">            not inclusive of the Legistar vote value.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        cdp_backend.database.constants.VoteDecision</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vote_value</span> <span class="o">=</span> <span class="n">legistar_vote</span><span class="p">[</span><span class="n">LEGISTAR_VOTE_VAL_NAME</span><span class="p">]</span>
        <span class="c1"># don&#39;t want to make assumption about VoteValueId = 0 meaning here</span>
        <span class="c1"># so treating VoteValueId as null only when None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vote_value</span> <span class="ow">and</span> <span class="n">legistar_vote</span><span class="p">[</span><span class="n">LEGISTAR_VOTE_VAL_ID</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># NOTE: The required integer VoteValueId = 16 seems to be &quot;in favor&quot;.</span>
        <span class="c1">#       But don&#39;t know what other values would be e.g. &quot;opposed to&quot;, etc.</span>
        <span class="c1">#       Therefore deciding VoteDecision based on the string VoteValueName.</span>

        <span class="n">decision</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vote_approve_pattern</span><span class="p">,</span>
                <span class="n">vote_value</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="n">VoteDecision</span><span class="o">.</span><span class="n">APPROVE</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vote_reject_pattern</span><span class="p">,</span>
                <span class="n">vote_value</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="n">VoteDecision</span><span class="o">.</span><span class="n">REJECT</span>

        <span class="n">nonvoting</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vote_nonvoting_pattern</span><span class="p">,</span>
                <span class="n">vote_value</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># determine qualifer like absent, abstain</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vote_absent_pattern</span><span class="p">,</span>
                <span class="n">vote_value</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">decision</span> <span class="o">==</span> <span class="n">VoteDecision</span><span class="o">.</span><span class="n">APPROVE</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">VoteDecision</span><span class="o">.</span><span class="n">ABSENT_APPROVE</span>
            <span class="k">elif</span> <span class="n">decision</span> <span class="o">==</span> <span class="n">VoteDecision</span><span class="o">.</span><span class="n">REJECT</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">VoteDecision</span><span class="o">.</span><span class="n">ABSENT_REJECT</span>
            <span class="k">elif</span> <span class="n">nonvoting</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">VoteDecision</span><span class="o">.</span><span class="n">ABSENT_NON_VOTING</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vote_abstain_pattern</span><span class="p">,</span>
                <span class="n">vote_value</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">decision</span> <span class="o">==</span> <span class="n">VoteDecision</span><span class="o">.</span><span class="n">APPROVE</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">VoteDecision</span><span class="o">.</span><span class="n">ABSTAIN_APPROVE</span>
            <span class="k">elif</span> <span class="n">decision</span> <span class="o">==</span> <span class="n">VoteDecision</span><span class="o">.</span><span class="n">REJECT</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">VoteDecision</span><span class="o">.</span><span class="n">ABSTAIN_REJECT</span>
            <span class="k">elif</span> <span class="n">nonvoting</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">VoteDecision</span><span class="o">.</span><span class="n">ABSTAIN_NON_VOTING</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">decision</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no VoteDecision filter for </span><span class="si">{</span><span class="n">vote_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decision</span></div>

<div class="viewcode-block" id="LegistarScraper.get_body"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_body">[docs]</a>    <span class="k">def</span> <span class="nf">get_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legistar_body</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Body</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return CDP Body for Legistar body.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        legistar_body: Dict</span>
<span class="sd">            Legistar API body</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        body: Optional[body]</span>
<span class="sd">            The Legistar body converted to a CDP body ingestion model.</span>
<span class="sd">            None if missing required information.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        get_legistar_body</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">legistar_body</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_none_if_empty</span><span class="p">(</span>
            <span class="n">Body</span><span class="p">(</span>
                <span class="n">external_source_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">legistar_body</span><span class="p">[</span><span class="n">LEGISTAR_BODY_EXT_ID</span><span class="p">]),</span>
                <span class="n">is_active</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">legistar_body</span><span class="p">[</span><span class="n">LEGISTAR_BODY_ACTIVE</span><span class="p">]),</span>
                <span class="n">name</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_body</span><span class="p">[</span><span class="n">LEGISTAR_BODY_NAME</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LegistarScraper.use_or_replace_role"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.use_or_replace_role">[docs]</a>    <span class="k">def</span> <span class="nf">use_or_replace_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role_title</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lookup if the provided role title should be replaced with a CDP standard value.</span>
<span class="sd">        If the provided role title should be replaced, then return the proper</span>
<span class="sd">        replacement title, otherwise if the title wasn&#39;t found in the role replacement</span>
<span class="sd">        lookup table, return the provided role_title unchanged.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        role_title: str</span>
<span class="sd">            The role title to check and potentially replace with a CDP standard.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        role_title: str</span>
<span class="sd">            The original role title if no replacement was found in the role replacements</span>
<span class="sd">            lookup-table, or the CDP standard title swapped from the lookup-table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">role_title</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">role_replacements</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">role_replacements</span><span class="p">[</span><span class="n">role_title</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">role_title</span></div>

<div class="viewcode-block" id="LegistarScraper.get_roles"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_roles">[docs]</a>    <span class="k">def</span> <span class="nf">get_roles</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">legistar_office_records</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Role</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of CDP Role from list of legistar OfficeRecord.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        legistar_office_records: List[Dict]</span>
<span class="sd">            Legistar API OfficeRecords</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        roles: Optional[List[Role]]</span>
<span class="sd">            From Legistar OfficeRecords. None if missing information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">legistar_office_records</span><span class="p">:</span>
            <span class="n">legistar_office_records</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">reduced_list</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_none_if_empty</span><span class="p">(</span>
                    <span class="n">Role</span><span class="p">(</span>
                        <span class="n">body</span><span class="o">=</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_body</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">LEGISTAR_ROLE_BODY</span><span class="p">])</span>
                            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_none_if_empty</span><span class="p">(</span>
                                <span class="n">Body</span><span class="p">(</span>
                                    <span class="n">name</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">LEGISTAR_ROLE_BODY_ALT</span><span class="p">]),</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="c1"># e.g. 2017-11-30T00:00:00</span>
                        <span class="n">start_datetime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">localize_datetime</span><span class="p">(</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                                <span class="n">record</span><span class="p">[</span><span class="n">LEGISTAR_ROLE_START</span><span class="p">],</span>
                                <span class="n">LEGISTAR_DATETIME_FORMAT</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">end_datetime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">localize_datetime</span><span class="p">(</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                                <span class="n">record</span><span class="p">[</span><span class="n">LEGISTAR_ROLE_END</span><span class="p">],</span> <span class="n">LEGISTAR_DATETIME_FORMAT</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">external_source_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">LEGISTAR_ROLE_EXT_ID</span><span class="p">]),</span>
                        <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_or_replace_role</span><span class="p">(</span>
                            <span class="n">str_simplified</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">LEGISTAR_ROLE_TITLE</span><span class="p">])</span>
                            <span class="ow">or</span> <span class="n">str_simplified</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">LEGISTAR_ROLE_TITLE_ALT</span><span class="p">])</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">legistar_office_records</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LegistarScraper.resolve_person_alias"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.resolve_person_alias">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_person_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person</span><span class="p">:</span> <span class="n">Person</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Person</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If input person is in fact an alias of a reference known person,</span>
<span class="sd">        return the reference person instead.</span>
<span class="sd">        Else return person as-is.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        person: Person</span>
<span class="sd">            Person to check whether is an alias or a real unique Person</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Person</span>
<span class="sd">            input person, or the correct reference Person if input person is an alias.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        instances.seattle.person_aliases</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># nothing to do if the input person is a reference person itself</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_aliases</span> <span class="ow">or</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_aliases</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">person</span>

        <span class="n">request_format</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">LEGISTAR_PERSON_BASE</span> <span class="o">+</span> <span class="s2">&quot;?$filter=PersonFullName+eq+%27</span><span class="si">{name}</span><span class="s2">%27&quot;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">aliases</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_aliases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="c1"># found the reference person with input person.name as an alias</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># query to get PersonId for the reference person we want to use</span>
                    <span class="c1"># in place of the input person</span>
                    <span class="n">response</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">request_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">JSONDecodeError</span><span class="p">:</span>
                    <span class="n">response</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">LEGISTAR_PERSON_EXT_ID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, an alias of </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;but failed get valid JSON for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> from Legistar API. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Keeping this alias </span><span class="si">{</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> without resolving.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">person</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_person</span><span class="p">(</span>
                    <span class="n">get_legistar_person</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
                        <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">LEGISTAR_PERSON_EXT_ID</span><span class="p">],</span>
                        <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># input person is not an alias of a reference Person</span>
        <span class="k">return</span> <span class="n">person</span></div>

<div class="viewcode-block" id="LegistarScraper.get_person"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_person">[docs]</a>    <span class="k">def</span> <span class="nf">get_person</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legistar_person</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Person</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return CDP Person for Legistar Person.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        legistar_person: Dict</span>
<span class="sd">            Legistar API Person</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        person: Optional[Person]</span>
<span class="sd">            The Legistar Person converted to a CDP person ingestion model.</span>
<span class="sd">            None if missing information.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        get_legistar_person</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">legistar_person</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">legistar_person</span><span class="p">[</span><span class="n">LEGISTAR_PERSON_NAME</span><span class="p">]</span>
            <span class="c1"># have seen PersonFullName with something like &quot;no sponsor required&quot;</span>
            <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;no.*required&quot;</span><span class="p">,</span> <span class="n">legistar_person</span><span class="p">[</span><span class="n">LEGISTAR_PERSON_NAME</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">phone</span> <span class="o">=</span> <span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_person</span><span class="p">[</span><span class="n">LEGISTAR_PERSON_PHONE</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">phone</span><span class="p">:</span>
            <span class="c1"># (123)456... -&gt; 123-456...</span>
            <span class="n">phone</span> <span class="o">=</span> <span class="n">phone</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_none_if_empty</span><span class="p">(</span>
            <span class="c1"># If applicable, catch [mistakenly] entered duplicate persons.</span>
            <span class="c1"># i.e. Don&#39;t create unique Person objects for the same real person.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resolve_person_alias</span><span class="p">(</span>
                <span class="n">Person</span><span class="p">(</span>
                    <span class="n">email</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_person</span><span class="p">[</span><span class="n">LEGISTAR_PERSON_EMAIL</span><span class="p">]),</span>
                    <span class="n">external_source_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">legistar_person</span><span class="p">[</span><span class="n">LEGISTAR_PERSON_EXT_ID</span><span class="p">]),</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_person</span><span class="p">[</span><span class="n">LEGISTAR_PERSON_NAME</span><span class="p">]),</span>
                    <span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">,</span>
                    <span class="n">website</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_person</span><span class="p">[</span><span class="n">LEGISTAR_PERSON_WEBSITE</span><span class="p">]),</span>
                    <span class="n">is_active</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">legistar_person</span><span class="p">[</span><span class="n">LEGISTAR_PERSON_ACTIVE</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LegistarScraper.get_votes"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_votes">[docs]</a>    <span class="k">def</span> <span class="nf">get_votes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legistar_votes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Vote</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return List[Vote] for Legistar API Votes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        legistar_votes: List[Dict]</span>
<span class="sd">            Legistar votes as CDP Vote ingestion models.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        votes: Optional[List[Vote]]</span>
<span class="sd">            List of votes if any were provided.</span>
<span class="sd">            None if empty list or missing information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">reduced_list</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_none_if_empty</span><span class="p">(</span>
                    <span class="n">Vote</span><span class="p">(</span>
                        <span class="n">decision</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_vote_decision</span><span class="p">(</span><span class="n">vote</span><span class="p">),</span>
                        <span class="n">external_source_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">vote</span><span class="p">[</span><span class="n">LEGISTAR_VOTE_EXT_ID</span><span class="p">]),</span>
                        <span class="n">person</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_person</span><span class="p">(</span><span class="n">vote</span><span class="p">[</span><span class="n">LEGISTAR_VOTE_PERSONS</span><span class="p">]),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">vote</span> <span class="ow">in</span> <span class="n">legistar_votes</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LegistarScraper.get_event_supporting_files"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_event_supporting_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_event_supporting_files</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">legistar_ev_attachments</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SupportingFile</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return List[SupportingFile] for Legistar API MatterAttachments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        legistar_ev_attachments: List[Dict]</span>
<span class="sd">            Legistar API MatterAttachments</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        files: Optional[List[SupportingFile]]</span>
<span class="sd">            List of supporting files if provided.</span>
<span class="sd">            None if empty list or missing information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">reduced_list</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_none_if_empty</span><span class="p">(</span>
                    <span class="n">SupportingFile</span><span class="p">(</span>
                        <span class="n">external_source_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">attachment</span><span class="p">[</span><span class="n">LEGISTAR_FILE_EXT_ID</span><span class="p">]),</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">attachment</span><span class="p">[</span><span class="n">LEGISTAR_FILE_NAME</span><span class="p">]),</span>
                        <span class="n">uri</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">attachment</span><span class="p">[</span><span class="n">LEGISTAR_FILE_URI</span><span class="p">]),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">attachment</span> <span class="ow">in</span> <span class="n">legistar_ev_attachments</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LegistarScraper.get_sponsors"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_sponsors">[docs]</a>    <span class="k">def</span> <span class="nf">get_sponsors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legistar_sponsors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Person</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get legislation sponsors.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">legistar_sponsors</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">reduced_list</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_person</span><span class="p">(</span><span class="n">sponsor</span><span class="p">[</span><span class="s2">&quot;SponsorPersonInfo&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">sponsor</span> <span class="ow">in</span> <span class="n">legistar_sponsors</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LegistarScraper.get_matter"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_matter">[docs]</a>    <span class="k">def</span> <span class="nf">get_matter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legistar_ev</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matter</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return Matter from Legistar API EventItem.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        legistar_ev: Dict</span>
<span class="sd">            Legistar API EventItem</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        matter: Optional[Matter]</span>
<span class="sd">            List of converted Legistar matter details to CDP matter objects.</span>
<span class="sd">            None if missing information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_none_if_empty</span><span class="p">(</span>
            <span class="n">Matter</span><span class="p">(</span>
                <span class="n">external_source_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_MATTER_EXT_ID</span><span class="p">]),</span>
                <span class="c1"># Too often EventItemMatterName is not filled</span>
                <span class="c1"># but EventItemMatterFile is</span>
                <span class="n">name</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_MATTER_NAME</span><span class="p">])</span>
                <span class="ow">or</span> <span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_MATTER_TITLE</span><span class="p">]),</span>
                <span class="n">matter_type</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_MATTER_TYPE</span><span class="p">]),</span>
                <span class="n">sponsors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_sponsors</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_MATTER_SPONSORS</span><span class="p">]),</span>
                <span class="n">title</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_MATTER_TITLE</span><span class="p">]),</span>
                <span class="n">result_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_matter_status</span><span class="p">(</span>
                    <span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_MATTER_STATUS</span><span class="p">]</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LegistarScraper.get_minutes_item"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_minutes_item">[docs]</a>    <span class="k">def</span> <span class="nf">get_minutes_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legistar_ev_item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MinutesItem</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return MinutesItem from parts of Legistar API EventItem.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        legistar_ev_item: Dict</span>
<span class="sd">            Legistar API EventItem</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        minutes_item: Optional[MinutesItem]</span>
<span class="sd">            None if could not get nonempty MinutesItem.name from EventItem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_none_if_empty</span><span class="p">(</span>
            <span class="n">MinutesItem</span><span class="p">(</span>
                <span class="n">external_source_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">legistar_ev_item</span><span class="p">[</span><span class="n">LEGISTAR_MINUTE_EXT_ID</span><span class="p">]),</span>
                <span class="n">name</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_ev_item</span><span class="p">[</span><span class="n">LEGISTAR_MINUTE_NAME</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LegistarScraper.fix_event_minutes"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.fix_event_minutes">[docs]</a>    <span class="k">def</span> <span class="nf">fix_event_minutes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ev_minutes_item</span><span class="p">:</span> <span class="n">EventMinutesItem</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">legistar_ev_item</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EventMinutesItem</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inspect the MinutesItem and Matter in ev_minutes_item.</span>
<span class="sd">        - Move some fields between them to make the information more meaningful.</span>
<span class="sd">        - Enforce matter.result_status when appropriate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ev_minutes_item: Optional[EventMinutesItem]</span>
<span class="sd">            The specific event minutes item to clean.</span>
<span class="sd">            Or None if running this function in a loop with multiple event minutes</span>
<span class="sd">            items and you don&#39;t want to clean / the emi was filtered out.</span>
<span class="sd">        legistar_ev_item: Dict</span>
<span class="sd">            The original Legistar EventItem.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cleaned_emi: Optional[EventMinutesItem]</span>
<span class="sd">            The cleaned event minutes item. This can clean both the event minutes item</span>
<span class="sd">            and the attached matter information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ev_minutes_item</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ev_minutes_item</span>
        <span class="k">if</span> <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">minutes_item</span> <span class="ow">and</span> <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">matter</span><span class="p">:</span>
            <span class="c1"># we have both matter and minutes_item</span>
            <span class="c1"># - make minutes_item.name the more concise text e.g. &quot;CB 11111&quot;</span>
            <span class="c1"># - make minutes_item.description the more descriptive lengthy text</span>
            <span class="c1">#   e.g. &quot;AN ORDINANCE related to the...&quot;</span>
            <span class="c1"># - make matter.title the same descriptive lengthy text</span>
            <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">minutes_item</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">minutes_item</span><span class="o">.</span><span class="n">name</span>
            <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">minutes_item</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">matter</span><span class="o">.</span><span class="n">name</span>
            <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">matter</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">minutes_item</span><span class="o">.</span><span class="n">description</span>
        <span class="c1"># matter.result_status is allowed to be null</span>
        <span class="c1"># only when no votes or Legistar EventItemMatterStatus is null</span>
        <span class="k">if</span> <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">matter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">matter</span><span class="o">.</span><span class="n">result_status</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">votes</span> <span class="ow">and</span> <span class="n">legistar_ev_item</span><span class="p">[</span><span class="n">LEGISTAR_MATTER_STATUS</span><span class="p">]:</span>
                <span class="c1"># means did not find matter_*_pattern in Legistar EventItemMatterStatus.</span>
                <span class="c1"># default to in progress (as opposed to adopted or rejected)</span>
                <span class="c1"># NOTE: if our matter_*_patterns ARE &quot;complete&quot;,</span>
                <span class="c1">#       this clause would hit only because the info from Legistar</span>
                <span class="c1">#       is incomplete or malformed</span>
                <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">matter</span><span class="o">.</span><span class="n">result_status</span> <span class="o">=</span> <span class="n">MatterStatusDecision</span><span class="o">.</span><span class="n">IN_PROGRESS</span>

        <span class="k">return</span> <span class="n">ev_minutes_item</span></div>

<div class="viewcode-block" id="LegistarScraper.filter_event_minutes"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.filter_event_minutes">[docs]</a>    <span class="k">def</span> <span class="nf">filter_event_minutes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ev_minutes_item</span><span class="p">:</span> <span class="n">EventMinutesItem</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EventMinutesItem</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return None if minutes_item.name contains unimportant text</span>
<span class="sd">        that we want to ignore.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ev_minutes_item: EventMinutesItem</span>
<span class="sd">            The minutes item to filter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        filtered_event_minutes_items: Optional[EventMinutesItem]</span>
<span class="sd">            The allowed minutes item or None is filtered out.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">minutes_item</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">minutes_item</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ev_minutes_item</span>
        <span class="k">for</span> <span class="n">filter_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_minutes_item_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">filter_</span><span class="p">,</span> <span class="n">ev_minutes_item</span><span class="o">.</span><span class="n">minutes_item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">ev_minutes_item</span></div>

<div class="viewcode-block" id="LegistarScraper.get_event_minutes"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_event_minutes">[docs]</a>    <span class="k">def</span> <span class="nf">get_event_minutes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">legistar_ev_items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">EventMinutesItem</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return List[EventMinutesItem] for Legistar API EventItems.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        legistar_ev_items: List[Dict]</span>
<span class="sd">            Legistar API EventItems</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        event_minutes_items: Optional[List[EventMinutesItem]]</span>
<span class="sd">            Filtered set of event minutes items.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">reduced_list</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_none_if_empty</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fix_event_minutes</span><span class="p">(</span>
                        <span class="c1"># if minutes_item contains unimportant data,</span>
                        <span class="c1"># just make the entire EventMinutesItem = None</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">filter_event_minutes</span><span class="p">(</span>
                            <span class="n">EventMinutesItem</span><span class="p">(</span>
                                <span class="n">index</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="n">LEGISTAR_EV_INDEX</span><span class="p">],</span>
                                <span class="n">minutes_item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_minutes_item</span><span class="p">(</span><span class="n">item</span><span class="p">),</span>
                                <span class="n">votes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_votes</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">LEGISTAR_EV_VOTES</span><span class="p">]),</span>
                                <span class="n">matter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_matter</span><span class="p">(</span><span class="n">item</span><span class="p">),</span>
                                <span class="n">decision</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_minutes_item_decision</span><span class="p">(</span>
                                    <span class="n">item</span><span class="p">[</span><span class="n">LEGISTAR_EV_MINUTE_DECISION</span><span class="p">]</span>
                                <span class="p">),</span>
                                <span class="n">supporting_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_event_supporting_files</span><span class="p">(</span>
                                    <span class="n">item</span><span class="p">[</span><span class="n">LEGISTAR_EV_ATTACHMENTS</span><span class="p">]</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">item</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># EventMinutesItem object per member in EventItems</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">legistar_ev_items</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LegistarScraper.date_and_time_to_datetime"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.date_and_time_to_datetime">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">date_and_time_to_datetime</span><span class="p">(</span><span class="n">ev_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ev_time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return datetime from ev_date and ev_time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ev_date: str</span>
<span class="sd">            Formatted as &quot;%Y-%m-%dT%H:%M:%S&quot;</span>
<span class="sd">        ev_time: Optional[str]</span>
<span class="sd">            Formatted as &quot;%I:%M %p&quot;</span>
<span class="sd">            Or None and do not attach time to date.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        datetime</span>
<span class="sd">            date using ev_date and time using ev_time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 2021-07-09T00:00:00</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">ev_date</span><span class="p">)</span>
        <span class="c1"># 9:30 AM</span>
        <span class="c1"># some events may have ev_time =None</span>
        <span class="k">if</span> <span class="n">ev_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">ev_time</span><span class="p">,</span> <span class="s2">&quot;%I:%M %p&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span>
                <span class="n">year</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                <span class="n">month</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                <span class="n">day</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                <span class="n">hour</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                <span class="n">minute</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                <span class="n">second</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span>
                <span class="n">year</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                <span class="n">month</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                <span class="n">day</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="LegistarScraper.get_content_uris"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_content_uris">[docs]</a>    <span class="k">def</span> <span class="nf">get_content_uris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legistar_ev</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">ContentURIs</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Must implement in class derived from LegistarScraper.</span>
<span class="sd">        If Legistar Event.EventVideoPath is used, return an empty list in the override.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        legistar_ev: Dict</span>
<span class="sd">            Data for one Legistar Event.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        event_content_uris: List[ContentURIs]</span>
<span class="sd">            List of ContentURIs objects for each session found.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            This base implementation does nothing</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        cdp_scrapers.legistar_utils.get_legistar_events_for_timespan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># see if our base legistar/granicus video parsing routine will work</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">uris</span> <span class="o">=</span> <span class="n">get_legistar_content_uris</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">legistar_ev</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">ContentUriScrapeResult</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">UnrecognizedPatternError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">uris</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Please provide get_content_uris() for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LegistarScraper.inject_known_person"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.inject_known_person">[docs]</a>    <span class="k">def</span> <span class="nf">inject_known_person</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person</span><span class="p">:</span> <span class="n">Person</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Person</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inject information if person exists in static_data.persons.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        person: Person</span>
<span class="sd">            Person into which to inject data from static_data</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Person</span>
<span class="sd">            Input person updated with information from static_data,</span>
<span class="sd">            and seat.roles sanitized.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        scraper_utils.sanitize_roles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">known_person</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_data</span><span class="o">.</span><span class="n">persons</span><span class="p">[</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">person</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">person</span><span class="o">.</span><span class="n">__dataclass_fields__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">static_info</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">known_person</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">static_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># have long-term information provided in &quot;static*.json&quot;</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">static_info</span><span class="p">))</span>

        <span class="c1"># now that we have seat from static hard-coded data</span>
        <span class="c1"># we can bring in seat.roles (OfficeRecords from Legistar API)</span>
        <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">seat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">person</span><span class="o">.</span><span class="n">seat</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">sanitize_roles</span><span class="p">(</span>
                <span class="n">person_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">roles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_roles</span><span class="p">(</span>
                    <span class="n">legistar_office_records</span><span class="o">=</span><span class="n">get_legistar_person</span><span class="p">(</span>
                        <span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
                        <span class="n">person_id</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">external_source_id</span><span class="p">,</span>
                        <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)[</span><span class="n">LEGISTAR_PERSON_ROLES</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">static_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">static_data</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">person</span></div>

<div class="viewcode-block" id="LegistarScraper.inject_known_data"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.inject_known_data">[docs]</a>    <span class="k">def</span> <span class="nf">inject_known_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">EventIngestionModel</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">EventIngestionModel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Augment with long-term static data that changes very infrequently.</span>
<span class="sd">        e.e. self.static_data which includes Person.picture_uri, Person.seat.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        events:</span>
<span class="sd">            Returned events from get_events()</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        events: List[EventIngestionModel]</span>
<span class="sd">            Input events with static information possibly injected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># don&#39;t waste time if we don&#39;t have any info at all</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">events</span>

        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">event_minutes_items</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># 2 places for Person:</span>
            <span class="c1"># EventMinutesItem.matter.sponsors</span>
            <span class="c1"># EventMinutesItem.votes.person</span>
            <span class="k">for</span> <span class="n">minute_item</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">event_minutes_items</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">minute_item</span><span class="o">.</span><span class="n">matter</span> <span class="ow">and</span> <span class="n">minute_item</span><span class="o">.</span><span class="n">matter</span><span class="o">.</span><span class="n">sponsors</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sponsor</span> <span class="ow">in</span> <span class="n">minute_item</span><span class="o">.</span><span class="n">matter</span><span class="o">.</span><span class="n">sponsors</span><span class="p">:</span>
                        <span class="n">sponsor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_known_person</span><span class="p">(</span><span class="n">sponsor</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">minute_item</span><span class="o">.</span><span class="n">votes</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">vote</span> <span class="ow">in</span> <span class="n">minute_item</span><span class="o">.</span><span class="n">votes</span><span class="p">:</span>
                        <span class="n">vote</span><span class="o">.</span><span class="n">person</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_known_person</span><span class="p">(</span><span class="n">vote</span><span class="o">.</span><span class="n">person</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">events</span></div>

<div class="viewcode-block" id="LegistarScraper.post_process_ingestion_models"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.post_process_ingestion_models">[docs]</a>    <span class="k">def</span> <span class="nf">post_process_ingestion_models</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">EventIngestionModel</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">EventIngestionModel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called at the end of get_events() for fully custom site-specific prcessing.</span>
<span class="sd">        inject_known_data() already operated on input events.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        events:</span>
<span class="sd">            Returned events from get_events()</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        events: List[EventIngestionModel]</span>
<span class="sd">            Base implementation simply returns input events as-is</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">events</span></div>

<div class="viewcode-block" id="LegistarScraper.get_events"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.get_events">[docs]</a>    <span class="k">def</span> <span class="nf">get_events</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">begin</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">EventIngestionModel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls get_legistar_events_for_timespan to retrieve Legistar API data</span>
<span class="sd">        and return as List[EventIngestionModel].</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        begin: datetime, optional</span>
<span class="sd">            The timespan beginning datetime to query for events after.</span>
<span class="sd">            Default is 2 days from UTC now</span>
<span class="sd">        end: datetime, optional</span>
<span class="sd">            The timespan end datetime to query for events before.</span>
<span class="sd">            Default is UTC now</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        events: List[EventIngestionModel]</span>
<span class="sd">            One instance of EventIngestionModel per Legistar Event</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        cdp_scrapers.legistar_utils.get_legistar_events_for_timespan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">begin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="n">ingestion_models</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">legistar_ev</span> <span class="ow">in</span> <span class="n">get_legistar_events_for_timespan</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span>
        <span class="p">):</span>
            <span class="c1"># better to return time as local time with time zone info,</span>
            <span class="c1"># rather than as utc time.</span>
            <span class="c1"># this way the calling pipeline can find out what is the local zone.</span>
            <span class="n">session_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localize_datetime</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">date_and_time_to_datetime</span><span class="p">(</span>
                    <span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_SESSION_DATE</span><span class="p">],</span>
                    <span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_SESSION_TIME</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">list_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_uris</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[</span>
                <span class="n">ContentURIs</span><span class="p">(</span><span class="n">video_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">caption_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="n">ingestion_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_none_if_empty</span><span class="p">(</span>
                    <span class="n">EventIngestionModel</span><span class="p">(</span>
                        <span class="n">external_source_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_EV_EXT_ID</span><span class="p">]),</span>
                        <span class="n">agenda_uri</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_AGENDA_URI</span><span class="p">]),</span>
                        <span class="n">minutes_uri</span><span class="o">=</span><span class="n">str_simplified</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_MINUTES_URI</span><span class="p">]),</span>
                        <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_body</span><span class="p">(</span><span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_EV_BODY</span><span class="p">]),</span>
                        <span class="n">sessions</span><span class="o">=</span><span class="n">reduced_list</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">get_none_if_empty</span><span class="p">(</span>
                                    <span class="n">Session</span><span class="p">(</span>
                                        <span class="n">session_datetime</span><span class="o">=</span><span class="n">session_time</span><span class="p">,</span>
                                        <span class="n">session_index</span><span class="o">=</span><span class="n">list_uri</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">content_uris</span><span class="p">),</span>
                                        <span class="n">video_uri</span><span class="o">=</span><span class="n">content_uris</span><span class="o">.</span><span class="n">video_uri</span><span class="p">,</span>
                                        <span class="n">caption_uri</span><span class="o">=</span><span class="n">content_uris</span><span class="o">.</span><span class="n">caption_uri</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                                <span class="c1"># Session per video</span>
                                <span class="k">for</span> <span class="n">content_uris</span> <span class="ow">in</span> <span class="n">list_uri</span>
                            <span class="p">]</span>
                        <span class="p">),</span>
                        <span class="n">event_minutes_items</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_event_minutes</span><span class="p">(</span>
                            <span class="n">legistar_ev</span><span class="p">[</span><span class="n">LEGISTAR_EV_ITEMS</span><span class="p">]</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># easier for calling pipeline to handle an empty list rather than None</span>
        <span class="c1"># so request reduced_list() to give me [], not None</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">reduced_list</span><span class="p">(</span><span class="n">ingestion_models</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_known_data</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_process_ingestion_models</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">events</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_legistar_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that Legistar API recognizes client name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        compatible: bool</span>
<span class="sd">            True if client_name is a valid Legistar client name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># simplest check, if the GET request works, it is a legistar municipality</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;http://webapi.legistar.com/v1/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="si">}</span><span class="s2">/bodies&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="k">except</span> <span class="n">URLError</span> <span class="ow">or</span> <span class="n">HTTPError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="LegistarScraper.check_for_cdp_min_ingestion"><a class="viewcode-back" href="../../cdp_scrapers.html#cdp_scrapers.legistar_utils.LegistarScraper.check_for_cdp_min_ingestion">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_cdp_min_ingestion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test if can obtain at least one minimally defined EventIngestionModel.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        check_days: int, default=7</span>
<span class="sd">            Test duration is the past check_days days from now</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        minimum_ingestion_data_available: bool</span>
<span class="sd">            True if got at least one minimally defined EventIngestionModel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># no point wasting time if the client isn&#39;t on legistar at all</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_legistar_compatible</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">days</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">check_days</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">days</span><span class="p">:</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Testing for minimal information &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">begin</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">end</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># ev: EventIngestionModel</span>
            <span class="k">for</span> <span class="n">cdp_ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">cdp_ev</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="ow">and</span> <span class="n">cdp_ev</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">session_datetime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdp_ev</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">video_uri</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="p">):</span>
                        <span class="n">session_time</span> <span class="o">=</span> <span class="n">cdp_ev</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">session_datetime</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Got minimal EventIngestionModel for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="si">}</span><span class="s2">: &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;body=</span><span class="si">{</span><span class="n">cdp_ev</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;session=</span><span class="si">{</span><span class="n">session_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;video=</span><span class="si">{</span><span class="n">cdp_ev</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">video_uri</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">True</span>

                <span class="c1"># catch None or empty list</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="ow">or</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to get minimal EventIngestionModel for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;in the past </span><span class="si">{</span><span class="n">check_days</span><span class="si">}</span><span class="s2"> days from </span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="c1"># no event in check_days had enough for minimal ingestion model item</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    </body>
</html>